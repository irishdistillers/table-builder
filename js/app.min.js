"use strict";var rsTableBuilder={globals:{name:$('input[name="save-table-name"]'),saveDownload:$(".save-download"),saveBar:$(".save-table-area"),addRow:$("#add-row"),addCol:$("#add-col"),output:$(".save-table-btn"),copyOutput:$(".copy-output-btn"),copyTextarea:$("#copied-textarea"),clear:$(".clear-table-btn"),htmlString:$("#html-output"),fileInput:$("#hidden-files")},empty:{name:"",id:!1,headers:[{title:"Header"},{title:"Header"}],rows:[{cols:[{content:!1},{content:!1}]},{cols:[{content:!1},{content:!1}]}]},config:{},makeDroppable:function(t){var e=this,a=void 0;document.addEventListener("drag",function(t){"BUTTON"===t.srcElement.tagName&&(a=$(t.target).attr("type"))}),document.addEventListener("dragover",function(t){t.preventDefault()}),document.addEventListener("drop",function(n){n.preventDefault();var i=n.target;i.classList.contains("droptarget")||(i=$(i).closest(".droptarget").get(0)),"title"===a&&"0"===$(i).attr("data-td-index")&&i&&i.classList.contains("droptarget")?e.onDrop(i,a,t):"title"!==a&&i&&i.classList.contains("droptarget")&&e.onDrop(i,a,t)})},editingImage:null,onDrop:function(t,e,a){var n=parseInt($(t).attr("data-tr-index"),10),i=parseInt($(t).attr("data-td-index"),10),o=!1;e.match(/gen-text/gi)&&(o='<span data-inline-text="true">Click me to edit text.<span>'),e.match(/check/gi)&&(o="offered"),e.match(/times/gi)&&(o="notOffered"),e.match(/image/gi)&&(o="Upload Image...",this.editingImage=this.config.rows[n].cols[i],this.openFileBrowser()),e.match(/title/gi)&&(o='<p data-feat-title="true">Feature Title</p>'),this.config.rows[n].cols[i].content=o,this.saveLocal(),this.renderTable(a)},openFileBrowser:function(){this.globals.fileInput.click()},convertImage:function(t,e){var a=this,n=new FileReader;n.readAsDataURL(t),n.onload=function(){a.editingImage.content='<img src="'+n.result+'" />',a.saveLocal(),a.renderTable(e)},n.onerror=function(t){console.log("Error making base64: ",t)}},renderTable:function(t,e){var a=this;this.globals.name.val(this.config.name);var n=this.config.id;n||(n=this.uuid(),this.config.id=n);var i='<table class="productTable" id="rs-table-'+n+'">';if(this.config.headers.length>0&&(i+='\n        <thead class="productTable-header">\n          <tr class="productTable-row">',$.each(this.config.headers,function(t,a){var n=e?'<span contenteditable="true">'+a.title+"</span>":a.title;i+='<th class="productTable-name"'+(e?' style="position:relative;"':"")+(e?' data-th-index="'+t+'"':"")+">"+n+(e?'<button data-index="'+t+'" class="remove-col"></button>':"")+"</th>"}),i+="\n          </tr>\n        </thead>"),this.config.rows.length>0){i+='<tbody">';var o=Array.from({length:this.config.rows.length}).map(function(t,e){return e}).reverse();$.each(this.config.rows,function(t,a){var n=e?' style="z-index:'+o[t]+';"':"";i+='<tr class="productTable-row"'+n+">",a.cols.length>0&&$.each(a.cols,function(n,r){var l="",s="productTable-feature";r.content?("offered"===r.content||"notOffered"===r.content?s=s+"Item "+r.content:(l=r.content).match(/data-feat-title="true"/gi)?l=e?'<span contenteditable="true">'+l+"</span>":l:s+="Item",e||(l=(l=(l=l.replace(/ data-feat-title="true"/gi,"")).replace(/ data-inline-text="true"/gi,"")).replace(/ contenteditable="true"/gi,""))):l=e?'<span class="drop-hint">drop item here</span>':"";var c=e?' style="position:relative;z-index:'+o[t]+';"':"",d=e?'data-tr-index="'+t+'" data-td-index="'+n+'"':"",u=e?" droptarget":"",p=e&&n===a.cols.length-1?'<button data-index="'+t+'" class="remove-row"></button>':"";i+="<td "+d+' class="'+s+u+'"'+c+">"+l+p+"</td>"}),i+="</tr>"}),i+="</tbody>"}i+="</table>";var r='\n      <style type="text/css">\n        table#rs-table-'+n+" tbody tr td {\n          width: 1%;\n        }\n        @media screen and (max-width: 767px) {\n          table#rs-table-"+n+" tbody tr td {\n            width: 100%;\n          }  \n        }\n        table#rs-table-"+n+" .productTable-featureItem {\n          vertical-align: middle;\n        }\n        table#rs-table-"+n+" .productTable-feature p {\n          margin: 0;\n        }\n      </style>\n    ",l='\n    <script type="text/javascript">\n      $(\'table#rs-table-'+n+"').responsiveTable();\n    <\/script>";e||(this.output=""+r+i+l,this.globals.htmlString.text(rsTableBuilder.output),this.renderTable(t,!0)),this.packageForSave(),e&&(t.html(""+r+i),t.find("tbody tr .remove-row").click(function(e){a.removeRow(e,t)}),t.find("thead tr .remove-col").click(function(e){a.removeColumn(e,t)}),t.find("tbody tr td").each(function(){var e=this,a=$(this).find('p[data-feat-title="true"]');a.length&&a.parent('span[contenteditable="true"]').on("focusout",function(){console.log("save feature text"),rsTableBuilder.updateFeat(t,$(e),a)});var n=$(this).find("span");if(n.length&&n.attr("data-inline-text")){new Quill(n.get(0),{modules:{toolbar:[["bold","italic","underline"],[{list:"ordered"},{list:"bullet"}],[{script:"sub"},{script:"super"}],[{align:[]}]]},theme:"bubble"});n.on("focusout",function(){console.log("save text"),rsTableBuilder.updateText(t,$(e))})}}),t.find("thead th").each(function(){var e=$(this);e.find('span[contenteditable="true"]').on("focusout",function(a){rsTableBuilder.updateHeader(t,e,a.target)}),e.hover(function(){t.find("tbody tr").each(function(){$(this).find("td").eq(e.index()).addClass("hover-col")})},function(){t.find("tbody tr").each(function(){$(this).find("td").eq(e.index()).removeClass("hover-col")})})}),t.find("table.productTable").responsiveTable())},updateText:function(t,e){var a=parseInt(e.attr("data-tr-index"),10),n=parseInt(e.attr("data-td-index"),10),i=e.find("span > .ql-editor").html();this.config.rows[a].cols[n].content='<span data-inline-text="true">'+i+"</span>",this.saveLocal(),this.renderTable(t)},updateHeader:function(t,e,a){var n=parseInt(e.attr("data-th-index"),10),i=$(a).text();this.config.headers[n].title=i,this.saveLocal(),this.renderTable(t)},updateFeat:function(t,e,a){var n=parseInt(e.attr("data-tr-index"),10),i=parseInt(e.attr("data-td-index"),10),o=$(a).text();this.config.rows[n].cols[i].content='<p data-feat-title="true">'+o+"</p>",this.saveLocal(),this.renderTable(t)},addRow:function(t){for(var e=this.config.headers.length,a=[],n=0;n<e;n+=1)a.push({content:!1});this.config.rows.push({cols:a}),this.saveLocal(),this.renderTable(t)},removeRow:function(t,e){var a=parseInt($(t.target).attr("data-index"),10);this.config.rows.splice(a,1),this.saveLocal(),this.renderTable(e)},addColumn:function(t){this.config.headers.push({title:"Header"}),$.each(this.config.rows,function(t,e){e.cols.push({content:!1})}),this.saveLocal(),this.renderTable(t)},removeColumn:function(t,e){var a=parseInt($(t.target).attr("data-index"),10);this.config.headers.splice(a,1),$.each(this.config.rows,function(t,e){e.cols.splice(a,1)}),this.saveLocal(),this.renderTable(e)},uuid:function(){function t(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return""+t()+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()},saveLocal:function(){localStorage.setItem("SAVED_TABLE",JSON.stringify(this.config))},file:null,output:"",copyOutput:function(t){var e=rsTableBuilder;e.globals.copyTextarea.val(e.output),e.globals.copyTextarea.select(),document.execCommand("copy"),$(t.target).addClass("drupal-copied"),e.globals.htmlString.addClass("drupal-copied-output"),setTimeout(function(){$(t.target).removeClass("drupal-copied"),e.globals.htmlString.removeClass("drupal-copied-output")},1200)},openSave:function(){rsTableBuilder.globals.saveBar.slideToggle(200)},packageForSave:function(){this.globals.name.val(this.config.name);var t=this.config.name;""===t.trim()&&(t="table-generated-file");var e=this.globals.saveDownload,a=new Blob([JSON.stringify(this.config)],{type:"application/json"});null!==this.file&&window.URL.revokeObjectURL(this.file),this.file=window.URL.createObjectURL(a),e.attr("href",this.file),e.attr("download",t+".json")},bindImport:function(t){var e=this,a=$("#import-table");a.get(0).ondragover=function(){return a.addClass("hover-file"),!1},a.get(0).ondragleave=function(){return a.removeClass("hover-file"),!1},a.get(0).ondrop=function(n){a.removeClass("hover-file"),n.preventDefault();var i=n.dataTransfer.files[0];if(i.name.split(".").pop().match(/json/gi)){var o=new FileReader;o.onload=function(n){a.removeClass("wrong-file-type"),e.config=JSON.parse(n.target.result),e.saveLocal(),e.renderTable(t),a.addClass("correct-file-type"),setTimeout(function(){a.removeClass("correct-file-type")},1500)},o.readAsText(i)}else a.addClass("wrong-file-type"),setTimeout(function(){a.removeClass("wrong-file-type")},2e3);return!1}},updateTableName:function(t,e){this.config.name=t,this.saveLocal(),this.renderTable(e)},nameTimeOut:null,init:function(t){var e=this;this.globals.name.on("input",function(a){clearTimeout(e.nameTimeOut),e.nameTimeOut=setTimeout(function(){e.updateTableName(a.target.value,t)},250)}),this.globals.addRow.click(function(){e.addRow(t)}),this.globals.addCol.click(function(){e.addColumn(t)}),this.globals.output.click(function(){e.openSave(t)}),this.globals.copyOutput.click(this.copyOutput),this.globals.clear.click(function(){e.config=JSON.parse(JSON.stringify(e.empty)),e.saveLocal(),e.renderTable(t)}),this.globals.fileInput.on("change",function(a){1===a.target.files.length&&e.convertImage(a.target.files[0],t),a.target.value=null}),this.bindImport(t),this.renderTable(t),this.makeDroppable(t)}};localStorage.SAVED_TABLE?rsTableBuilder.config=JSON.parse(localStorage.SAVED_TABLE):rsTableBuilder.config=JSON.parse(JSON.stringify(rsTableBuilder.empty)),rsTableBuilder.init($("#table-output"));